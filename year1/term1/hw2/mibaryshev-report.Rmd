---
title: 'HW 2: Анализ маркетинговой кампании'
author: "Барышев Матвей, mibaryshev"
output: 
  html_document:
    code_folding: hide
---

## Задача

Мы разработали новую маркетинговую кампанию, запустили её на тест в одном из наших магазинов и перед тем, 
как расширять ее на остальные магазины, нам нужно проанализировать результаты.

Основной задачей будет провести разведывательный анализ данных, включая проверку взаимосвязей с помощью статистических тестов, а также применить деревья решений для задачи классификации – предсказать, примет ли клиент предложение в рамках кампании.
  
Оформить результат в виде дэшборда с основными результатами + отчета с пояснениями 
(какие гипотезы проверены, какие группы исследованы и почему, какие предсказания в каких группах получились).

---

### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(ggstatsplot)
library(gridExtra)
library(rpart)
library(rpart.plot)

marketing = read.csv("~/shared/minor2_2022/1-Intro/hw2/marketing_campaign.csv")
```

Первым делом преобразуем переменную Response в факторную переменную. Так же преобразуем
переменные Marital_Status и Education. Переменную Dt_Customer, обозначающую дату, преобразуем
к типу Date.
Для более удобной работы колонка Year_Birth была преобразована в колонку Age, отображающую
возраст клиента. Расчёт ведётся относительно 2014г из-за того, что крайняя дата в колонке
Dt_Customer (дата, когда респондент стал клиентом компании) 28 июня 2014г.
Была создана колонка TotalSpent, которая включает в себя все расходы клиента.
Также в ходе анализа были обнаружены и удалены выбросы.


```{r message = FALSE}
marketing$Response = as.factor(marketing$Response)
marketing$AcceptedCmp = as.factor(marketing$AcceptedCmp)
marketing$Education = as.factor(marketing$Education)
marketing$Marital_Status = as.factor(marketing$Marital_Status)

marketing$Dt_Customer = lubridate::dmy(marketing$Dt_Customer)

colnames(marketing)[2] = "Age"
marketing = mutate(marketing, Age = 2014 - Age)

marketing = mutate(marketing, TotalSpent = MntWines + MntFruits + MntMeatProducts + MntFishProducts + MntSweetProducts)
# Удаление выбросов:
marketing = marketing %>% filter(Age < 100 & Income < 600000)
marketing = marketing %>% filter(TotalSpent > 250 | Income < 150000)
```

---

### Исследовательские вопросы и тесты

#### Вопрос 1

**Существует ли какая-то взаимосвязь между доходами и расходами наших клиентов?**

Для начала построим графики распределения доходов и расходов среди наших покупателей.
```{r message = FALSE}
a = ggplot() +
  geom_histogram(data = marketing, aes(x = TotalSpent), bins = 6, color = "black", fill = "#00BF7D", alpha = 0.8) +
  scale_x_continuous(breaks=seq(0,2500,by=500)) + 
  ggtitle("Распределение расходов") +
  ylab("Количество людей") +
  xlab("Общие расходы за 2 года") +
  theme_bw()

b = ggplot() +
  geom_histogram(data = marketing, aes(x = Income), color = "black", fill = "#D2691E", alpha = 0.8) + 
  ggtitle("Распределение доходов") +
  xlab("Доходы в год") +
  ylab('') +
  theme_bw()
grid.arrange(a, b, ncol = 2, nrow = 1)
```

Из данных графиков видно, что доходы наших клиентов имеют нормальное распределение и 
в большинстве случаев не превышают 100000 у.е. Также можно заметить, что большинство 
клиентов не тратят больше 250 у.е. на наши товары.


Построим диаграмму рассеивания по этим двум переменным для наглядной визуализации зависимости.
```{r message = FALSE}
ggscatterstats(data = marketing, x = TotalSpent, y = Income,
               type = 'p', centrality.para = 'mean', marginal.type = 'histogram',
               results.subtitle = FALSE,
               title = 'Зависимость общих расходов от ежегодного дохода клиента',
               xlab = 'Расходы',
               ylab = 'Доходы',
               ggtheme = ggplot2::theme_bw())
```

На графике можно заметить некоторую прямую зависимость этих двух переменных. Для подтверждения этого факта
проведём корреляционный тест.

```{r message = FALSE, results='hide'}
cor.test(marketing$Income, marketing$TotalSpent)
```

По результатам теста коэффициент корреляции равен 0.83. Это подтверждает гипотезу, что между данными
двумя переменными существует сильная прямая зависимость, причем она статистически значима,
т.к p-value намного меньше 0.05.

Такое широкое распределение доходов наших респондентов позволяет понять, что наша кампания
охватывает большую группу лиц, что помогает увеличивать прибыль.

#### Вопрос 2

**Правда ли, что пользователи, которые откликнулись на предыдущую кампанию, чаще откликаются и на нынешнюю кампанию?**

Для наглядности построим график, учитывающий отклики на прошлую компанию и нынешнюю.

```{r message=FALSE}
ggplot() +
  geom_bar(data = marketing, aes(x = AcceptedCmp, fill = Response), position = "fill", alpha = 0.8, color = 'black') + 
  ggtitle("Отклики на маркетинговые компании") +
  ylab('Доля людей') +
  xlab('Предыдущая компания') + 
  scale_x_discrete(labels = c("Не откликнулся", "Откликнулся")) + 
  ggthemes::scale_fill_economist(name = "Новая компания", labels = c("Не откликнулся", "Откликнулся")) +
  theme_bw()
```

Из графика явно видно, что большинство(~75%) среди тех, кто откликнулся на первую компанию, откликнулись и на текущую.

Проведём тест хи-квадрат для выявления зависимости.
```{r message=FALSE, results='hide'}
chisq.test(marketing$AcceptedCmp, marketing$Response)
```
В результате теста p-value получился < 2.2e-16, что означает статистически значимую зависимость
между двумя данными переменными. Гипотеза, что пользователи, которые откликнулись на предыдущую кампанию, чаще откликаются и на нынешнюю кампанию, подтверждена.

---

### Предсказание отклика на кампанию

Для предсказания отклика на нашу маркетинговую кампанию мы будем пользоваться деревом решений.

Для начала построим дерево для предсказания переменной Response по всем остальным переменным с ограничением cp = 0.001.
Также разобьём наш датасет на тренировочную и тестовую выборки.

```{r message=FALSE}
set.seed(123)
marketing_train = sample_frac(marketing, 0.8)
marketing_test = marketing %>% anti_join(marketing_train)

tree = rpart(Response ~ ., data = marketing_train, control = rpart.control(cp=0.001))
prp(tree, extra =4)
```

Сразу заметно, что наше дерево получилось слишком большим. Это может свидетельствовать о том, что наша модель 
переобучается, что может привести к плохим результатам на новых данных. Проверим это на тренировочной и
тестовой выборках.

```{r message=FALSE}
pred_train = predict(tree, marketing_train, type = "class")
t_train = table(pred_train, marketing_train$Response)
(t_train[1,1] + t_train[2,2])/sum(t_train)

pred_test = predict(tree, marketing_test, type = "class")
t_test = table(pred_test, marketing_test$Response)
(t_test[1,1] + t_test[2,2])/sum(t_test)
```

Отсюда видим, что результат отличается более чем на 0.1! Это как раз свидетельствует о том, что
наша модель 'привыкла' к тренировочным данным и заметно хуже работает на новых.

Вычислим оптимальное значение cp, при котором значение ошибки xerror минимально, чтобы избежать переобучения.

```{r message=FALSE, results='hide'}
cp_tbl = printcp(tree)

min_cp = cp_tbl %>%
  as.data.frame() %>% 
  arrange(xerror) %>% 
  head(n = 1)
min_cp
```

Оптимальное значение cp получились cp = 0.011 при 15 разбиениях.

Построим дерево с найденным значением cp = 0.011.

```{r message=FALSE}
tree = rpart(Response ~ . - ID, data = marketing_train, control = rpart.control(cp=0.011))
prp(tree, extra = 4)
```

Данное дерево уже не такое объёмное как предыдущее.

Проверим нашу модель на качество предсказания, вычислив Accuracy.

```{r message=FALSE}
pred_train = predict(tree, marketing_train, type = "class")
t_train = table(pred_train, marketing_train$Response)
(t_train[1,1] + t_train[2,2])/sum(t_train)

pred_test = predict(tree, marketing_test, type = "class")
t_test = table(pred_test, marketing_test$Response)
(t_test[1,1] + t_test[2,2])/sum(t_test)
```

Точность нашей модели на тренировочных и тестовых данных не так сильно отличается друг от друга, как
в случае с переобученной моделью.

Наше получившееся дерево решений предсказывает отклик на маркетинговую кампанию с точностью ~0.82.

Если рассмотреть получившееся дерево детальнее, то можно заметить, что модель обращает
внимание в первую очередь на то, принял ли клиент нашу прошлую кампанию. Как уже доказали выше 
этот фактор действительно является важным и люди, которых заинтересовала наша первая кампания с 
большой вероятностью были заинтересованы и нынешней.
Также модель учитывает дату, когда респондент стал клиентом компании и количество дней с момента последней покупки.
Разбиение по данным переменным встречается как в правой, так и в левой части дерева. Следовательно, данные
переменные тоже являются важными для предсказания отклика.

---

## Общие выводы

Исходя из проведённого анализа, можно сделать вывод, что большинство клиентов, которые были заинтересованы
в нашей прошлой кампании, остались заинтересованы в новой кампании. Также нам удалось привлечь
хорошее количество новых клиентов. А исходя из полученного дерева решений можно сказать,
что отклик на прошлую кампанию стал одним из ключевых факторов для предсказания отклика на новую.
Построенное дерево также помогает нам понять, что в предсказании отклика могут помочь
такие переменные как дата регистрации, количество дней с момента последней покупки, количество того или иного товара,
а также семейное положение. Ещё нам удалось выяснить, что наши клиенты имеют разные уровни доходов и расходов, причём 
они напрямую зависят друг от друга. Это показывает, что наши маркетинговые кампании ориентированы
на большой круг лиц, что помогает привлекать больше клиентов.


